# 开发指引

## 模块说明

### 核心模块：

- **控制台**： console_core
- **配置管理**：config_manager
- **硬件抽象层**：hardware_hal
- **事件管理**：event_manager

### 公共模块：

- **存储管理**：storage_manager
- **以太网管理**：ethernet_manager
- **GPIO 控制**：gpio_controller

### 控制模块：

- **设备控制器**：device_controller
- **LED 控制**：matrix_led, touch_led, board_led
- **风扇控制**：fan_controller
- **电源监控**：power_monitor
- **USB 多路复用控制**：usb_mux_controller

## 开发环境

烧录脚本：flash.sh
串口监控脚本：monitor.sh

## ESP-IDF 组件依赖

- **websocket**：https://components.espressif.com/components/espressif/esp_websocket_client/versions/1.5.0/readme


## WebSocket API

已经部署到agx服务器，源代码地址：https://github.com/thomas-hiddenpeak/rm01OrinStatus

### 连接信息

- URL: ws://{host}:{port}/socket.io/
- 协议 : Socket.IO
- 传输 : WebSocket
- 默认地址: ws://10.10.99.98:58090/socket.io/

### 连接限制

- 最大连接数: 10（可配置）
- 连接超时: 30秒
- 数据推送频率: 1Hz（每秒1次）

### 消息格式

- 消息类型: JSON
- 消息字段: 可以编码在控制台打印中查看也可以通过agx服务器所使用的源代码查看

## 功能需求

- 创建后台任务持续读取数据，需要保证实时性、稳定性，并且不会阻塞其他任务，当链接失败需要自动重连，有高可靠要求。
- 将数据写入变量中，以便其他组件读取（仅需要保存最新值）
- 创建agx_monitor组件来处理数据读取和WebSocket通信

## 开发要求

- 代码风格：遵循ESP-IDF的编码规范
- 注释：代码中必须包含必要的注释，特别是复杂逻辑部分
- 已经存在的核心组件和公共组件必须复用，细节请参考已有组件代码

## AGX Monitor 组件技术规范

### 架构设计原则

- **组件架构一致性**: 遵循现有组件设计模式（参考power_monitor、ethernet_manager）
- **文件结构**: `include/agx_monitor.h` + `agx_monitor.c` + `CMakeLists.txt`
- **依赖管理**: 依赖config_manager、event_manager、console_core等核心组件
- **任务管理**: 使用xTaskCreate创建后台任务，遵循现有任务命名和优先级规范

### 数据格式规范

AGX服务器通过Socket.IO的`tegrastats_update`事件推送以下JSON数据格式：

```json
{
  "timestamp": "2025-10-03T06:33:49.223455Z",
  "cpu": {
    "cores": [{"id": 0, "usage": 3, "freq": 1574}, ...]
  },
  "memory": {
    "ram": {"used": 1997, "total": 62841, "unit": "MB"},
    "swap": {"used": 0, "total": 31421, "cached": 0, "unit": "MB"}
  },
  "temperature": {
    "cpu": 47.125, "soc0": 45.0, "soc1": 46.062, "soc2": 45.562, "tj": 47.125
  },
  "power": {
    "gpu_soc": {"current": 2468, "average": 2468, "unit": "mW"},
    "cpu_cv": {"current": 246, "average": 246, "unit": "mW"},
    "sys_5v": {"current": 3383, "average": 3383, "unit": "mW"}
  },
  "gpu": {"gr3d_freq": 0}
}
```

### 核心API接口设计

```c
// 生命周期管理
esp_err_t agx_monitor_get_default_config(agx_monitor_config_t *config);
esp_err_t agx_monitor_init(const agx_monitor_config_t *config);
esp_err_t agx_monitor_deinit(void);
esp_err_t agx_monitor_start(void);
esp_err_t agx_monitor_stop(void);
bool agx_monitor_is_initialized(void);
esp_err_t agx_monitor_get_status(agx_monitor_status_t *status);

// 数据访问接口
esp_err_t agx_monitor_get_latest_data(agx_monitor_data_t *data);
bool agx_monitor_is_data_valid(void);
uint64_t agx_monitor_get_last_update_time(void);

// 回调和事件接口
esp_err_t agx_monitor_register_callback(agx_monitor_event_callback_t callback, void *user_data);
esp_err_t agx_monitor_unregister_callback(void);
```

### 数据存储策略

- **存储方式**: 使用静态内部状态结构体存储最新数据（仅保存最新值）
- **线程安全**: 使用SemaphoreHandle_t mutex保护数据读写操作
- **数据访问**: WebSocket任务写入，其他组件通过API读取
- **有效性标志**: 提供数据有效性检查和时间戳验证

### 错误处理和重连策略

#### 固定间隔重连机制（关键要求）
- **快速重试**: 断连后前3次使用1秒间隔快速重试
- **固定间隔**: 快速重试失败后使用固定3秒间隔持续重试
- **无限重试**: 默认启用连续重试，确保监控数据连续性
- **降级保护**: 重试期间保持上次有效数据

#### 重连时序设计
```
断连检测 → 立即重试(0s) → 1s → 2s → 3s (快速重试阶段)
        → 固定3秒间隔: 6s → 9s → 12s → ... (持续重试)
```

#### 错误分类处理
- **连接错误**: 网络不可达、服务器不可用、超时等
- **解析错误**: JSON格式错误、字段缺失、数据类型错误等
- **资源错误**: 内存不足、任务创建失败等

### 配置参数规范

```c
typedef struct {
    char server_url[128];            // WebSocket服务器URL (默认: "10.10.99.98")
    uint16_t server_port;            // 服务器端口 (默认: 58090)
    uint32_t reconnect_interval_ms;  // 固定重连间隔 (默认: 3000ms)
    uint32_t fast_retry_count;       // 快速重试次数 (默认: 3次)
    uint32_t fast_retry_interval_ms; // 快速重试间隔 (默认: 1000ms)
    uint32_t heartbeat_timeout_ms;   // 心跳超时 (默认: 10000ms)
    bool auto_start;                 // 自动启动 (默认: true)
    uint32_t task_stack_size;        // 任务堆栈大小 (默认: 8192)
    uint8_t task_priority;           // 任务优先级 (默认: 5)
} agx_monitor_config_t;
```

### 开发实施计划

1. **创建组件基础结构** - 建立文件框架和CMake配置
2. **实现核心数据结构** - 定义配置、状态、数据结构
3. **实现生命周期管理** - 初始化、启动、停止功能
4. **实现WebSocket客户端** - 集成ESP WebSocket库
5. **实现数据解析功能** - JSON解析和数据转换
6. **实现错误处理机制** - 重连和错误恢复逻辑
7. **实现控制台接口** - 调试和管理命令
8. **集成测试验证** - 系统兼容性测试

